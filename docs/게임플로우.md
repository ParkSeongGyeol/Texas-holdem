# 게임 플로우 정의 (Game Flow)

**작성자**: 박성결
**작성일**: 2025-10-01
**목적**: 핸드 시작부터 종료까지 전체 게임 흐름 정의

---

## 📚 목차
1. [전체 게임 흐름](#전체-게임-흐름)
2. [핸드 시작 시퀀스](#핸드-시작-시퀀스)
3. [딜러 버튼 관리](#딜러-버튼-관리)
4. [블라인드 처리](#블라인드-처리)
5. [베팅 라운드 흐름](#베팅-라운드-흐름)
6. [조기 종료 케이스](#조기-종료-케이스)
7. [쇼다운 및 팟 분배](#쇼다운-및-팟-분배)

---

## 전체 게임 흐름

### 하이레벨 시퀀스

```
┌─────────────────────────────────────────────────────┐
│                   게임 초기화                        │
│  - 플레이어 등록 (2~10명)                            │
│  - 초기 칩 분배 (각 1000칩)                          │
│  - 딜러 버튼 위치 설정                               │
└──────────────────┬──────────────────────────────────┘
                   ↓
         ┌─────────────────┐
         │  핸드 루프 시작  │ ←────────────────┐
         └────────┬─────────┘                  │
                  ↓                            │
         ┌─────────────────┐                  │
         │  1. 핸드 준비    │                  │
         │  - 덱 리셋/셔플  │                  │
         │  - 플레이어 리셋 │                  │
         │  - 딜러 버튼 이동│                  │
         └────────┬─────────┘                  │
                  ↓                            │
         ┌─────────────────┐                  │
         │  2. 블라인드     │                  │
         │  - SB 베팅       │                  │
         │  - BB 베팅       │                  │
         └────────┬─────────┘                  │
                  ↓                            │
         ┌─────────────────┐                  │
         │  3. 홀카드 딜링  │                  │
         │  - 각 2장 배분   │                  │
         └────────┬─────────┘                  │
                  ↓                            │
         ┌─────────────────┐                  │
         │ 4. PREFLOP 베팅  │                  │
         └────────┬─────────┘                  │
                  ↓                            │
                조기 종료? ─YES─→ (팟 분배) ───┤
                  │NO                          │
                  ↓                            │
         ┌─────────────────┐                  │
         │  5. FLOP         │                  │
         │  - 번카드 + 3장  │                  │
         │  - 베팅 라운드   │                  │
         └────────┬─────────┘                  │
                  ↓                            │
                조기 종료? ─YES─→ (팟 분배) ───┤
                  │NO                          │
                  ↓                            │
         ┌─────────────────┐                  │
         │  6. TURN         │                  │
         │  - 번카드 + 1장  │                  │
         │  - 베팅 라운드   │                  │
         └────────┬─────────┘                  │
                  ↓                            │
                조기 종료? ─YES─→ (팟 분배) ───┤
                  │NO                          │
                  ↓                            │
         ┌─────────────────┐                  │
         │  7. RIVER        │                  │
         │  - 번카드 + 1장  │                  │
         │  - 베팅 라운드   │                  │
         └────────┬─────────┘                  │
                  ↓                            │
                조기 종료? ─YES─→ (팟 분배) ───┤
                  │NO                          │
                  ↓                            │
         ┌─────────────────┐                  │
         │  8. SHOWDOWN     │                  │
         │  - 패 비교       │                  │
         │  - 팟 분배       │                  │
         └────────┬─────────┘                  │
                  ↓                            │
         ┌─────────────────┐                  │
         │  9. 핸드 종료    │                  │
         │  - 칩 0 체크     │                  │
         │  - 통계 업데이트 │                  │
         └────────┬─────────┘                  │
                  ↓                            │
            게임 계속? ─YES────────────────────┘
                  │NO
                  ↓
         ┌─────────────────┐
         │   게임 종료      │
         │  - 최종 순위     │
         │  - 통계 출력     │
         └─────────────────┘
```

---

## 핸드 시작 시퀀스

### 상세 플로우

```python
def new_hand(self):
    """새 핸드 시작"""
    print("\\n" + "="*50)
    print(f"  새 핸드 시작 (핸드 #{self.hand_number})")
    print("="*50 + "\\n")

    # 1. 게임 상태 초기화
    self.deck.reset()
    self.deck.shuffle()
    self.community_cards = []
    self.pot = 0
    self.current_bet = 0
    self.current_phase = GamePhase.PREFLOP

    # 2. 플레이어 상태 리셋
    for player in self.players:
        player.reset_for_new_hand()

    # 3. 활성 플레이어 확인 (칩이 있는 플레이어만)
    active_players = [p for p in self.players if p.is_active]
    if len(active_players) < 2:
        print("게임을 계속하기 위한 플레이어가 부족합니다.")
        return False

    # 4. 딜러 버튼 이동
    self.move_dealer_button()
    print(f"딜러 버튼: {self.players[self.dealer_position].name}")

    # 5. 블라인드 베팅
    self.post_blinds()

    # 6. 홀 카드 딜링
    self.deal_hole_cards()

    # 7. 게임 상태 출력
    self.display_game_state()

    return True
```

### 단계별 설명

#### 1단계: 게임 상태 초기화
```python
# 덱 리셋 및 셔플
self.deck.reset()        # 52장 카드 복구
self.deck.shuffle()      # Fisher-Yates 알고리즘

# 커뮤니티 카드 및 팟 초기화
self.community_cards = []
self.pot = 0
self.current_bet = 0
self.current_phase = GamePhase.PREFLOP
```

#### 2단계: 플레이어 리셋
```python
for player in self.players:
    player.reset_for_new_hand()
    # - hand = []
    # - current_bet = 0
    # - has_folded = False
    # - is_all_in = False
    # - is_active = (chips > 0)
```

#### 3단계: 활성 플레이어 검증
```python
active_players = [p for p in self.players if p.is_active]
if len(active_players) < 2:
    # 게임 종료 조건
    winner = active_players[0]
    print(f"\\n🏆 {winner.name}님이 우승했습니다!")
    return False
```

---

## 딜러 버튼 관리

### 딜러 버튼 이동 로직

```python
def move_dealer_button(self):
    """딜러 버튼을 다음 활성 플레이어로 이동"""
    if self.hand_number == 1:
        # 첫 핸드: 랜덤 또는 첫 번째 플레이어
        self.dealer_position = 0
    else:
        # 시계 방향으로 다음 활성 플레이어
        next_pos = (self.dealer_position + 1) % len(self.players)
        while not self.players[next_pos].is_active:
            next_pos = (next_pos + 1) % len(self.players)
        self.dealer_position = next_pos
```

### 포지션 계산

#### 2인 게임
```
딜러 버튼 = 플레이어 A
→ A가 스몰 블라인드 겸 딜러
→ B가 빅 블라인드

프리플롭 액션 순서: A → B
플롭 이후 액션 순서: B → A
```

#### 다인 게임 (3명 이상)
```
딜러 버튼 위치: 플레이어 D
스몰 블라인드: (D + 1) % num_players
빅 블라인드: (D + 2) % num_players

액션 순서 (프리플롭): (BB + 1) → ... → D → SB → BB
액션 순서 (플롭 이후): SB → BB → ... → D
```

### 구현 코드

```python
def get_sb_position(self) -> int:
    """스몰 블라인드 위치"""
    if len(self.players) == 2:
        # 2인 게임: 딜러가 SB
        return self.dealer_position
    else:
        # 다인 게임: 딜러 다음
        return (self.dealer_position + 1) % len(self.players)

def get_bb_position(self) -> int:
    """빅 블라인드 위치"""
    if len(self.players) == 2:
        # 2인 게임: 논-딜러가 BB
        return (self.dealer_position + 1) % len(self.players)
    else:
        # 다인 게임: SB 다음
        return (self.dealer_position + 2) % len(self.players)
```

---

## 블라인드 처리

### 블라인드 베팅 시퀀스

```python
def post_blinds(self):
    """블라인드 베팅 처리"""
    sb_pos = self.get_sb_position()
    bb_pos = self.get_bb_position()

    sb_player = self.players[sb_pos]
    bb_player = self.players[bb_pos]

    # 스몰 블라인드
    sb_amount = min(self.small_blind, sb_player.chips)
    actual_sb = sb_player.bet(sb_amount)
    self.pot += actual_sb
    print(f"💰 {sb_player.name}: 스몰 블라인드 {actual_sb} 베팅")

    # 빅 블라인드
    bb_amount = min(self.big_blind, bb_player.chips)
    actual_bb = bb_player.bet(bb_amount)
    self.pot += actual_bb
    self.current_bet = actual_bb
    print(f"💰 {bb_player.name}: 빅 블라인드 {actual_bb} 베팅")

    # 올인 체크
    if sb_player.is_all_in:
        print(f"  ⚠️  {sb_player.name} 올인!")
    if bb_player.is_all_in:
        print(f"  ⚠️  {bb_player.name} 올인!")

    print(f"\\n현재 팟: {self.pot}")
```

### 블라인드 금액 설정

```python
class PokerGame:
    def __init__(self):
        # 기본 블라인드
        self.small_blind = 5
        self.big_blind = 10

        # 블라인드 레벨 (토너먼트 모드)
        self.blind_level = 1
        self.hands_per_level = 10  # 10핸드마다 블라인드 상승
```

### 블라인드 상승 로직 (옵션)

```python
def increase_blinds(self):
    """블라인드 레벨 상승"""
    if self.hand_number % self.hands_per_level == 0:
        self.blind_level += 1
        self.small_blind *= 2
        self.big_blind *= 2
        print(f"\\n📈 블라인드 상승!")
        print(f"   레벨 {self.blind_level}: SB={self.small_blind}, BB={self.big_blind}")
```

---

## 베팅 라운드 흐름

### 베팅 라운드 실행

```python
def run_betting_round(self, phase: GamePhase):
    """베팅 라운드 실행"""
    print(f"\\n{'─'*50}")
    print(f"  {phase.value.upper()} 베팅 라운드")
    print(f"{'─'*50}")

    # 시작 위치 결정
    if phase == GamePhase.PREFLOP:
        # 프리플롭: BB 다음부터
        start_pos = (self.get_bb_position() + 1) % len(self.players)
    else:
        # 플롭 이후: SB부터
        start_pos = self.get_sb_position()

    # 베팅 라운드 진행
    current_pos = start_pos
    players_acted = {i: False for i in range(len(self.players))}
    action_count = 0

    while True:
        player = self.players[current_pos]

        # 액션 가능한 플레이어만
        if player.can_act():
            action, amount = self.get_player_action(player)
            self.process_action(player, action, amount, phase)
            players_acted[current_pos] = True
            action_count += 1

            # 조기 종료 체크
            if self.check_early_finish():
                print("\\n⚡ 한 명만 남아 베팅 라운드 종료")
                return True

        # 다음 플레이어
        current_pos = (current_pos + 1) % len(self.players)

        # 종료 조건 체크
        if self.is_betting_round_complete(players_acted, start_pos, current_pos):
            break

        # 무한 루프 방지
        if action_count > 100:
            print("⚠️  베팅 라운드 비정상 종료")
            break

    # 라운드 종료 정리
    self.cleanup_betting_round()
    return False  # 조기 종료 아님

def cleanup_betting_round(self):
    """베팅 라운드 종료 후 정리"""
    for player in self.players:
        player.current_bet = 0
    self.current_bet = 0
```

### 액션 처리

```python
def process_action(self, player: Player, action: Action, amount: int, phase: GamePhase):
    """플레이어 액션 처리"""
    if action == Action.FOLD:
        player.fold()
        print(f"  {player.name}: FOLD 💨")

    elif action == Action.CHECK:
        print(f"  {player.name}: CHECK ✋")

    elif action == Action.CALL:
        call_amount = self.current_bet - player.current_bet
        actual_bet = player.bet(call_amount)
        self.pot += actual_bet
        print(f"  {player.name}: CALL {actual_bet} 💵 (팟: {self.pot})")
        if player.is_all_in:
            print(f"    ⚠️  {player.name} 올인!")

    elif action == Action.RAISE:
        raise_amount = amount
        actual_bet = player.bet(raise_amount)
        self.pot += actual_bet
        self.current_bet = player.current_bet
        print(f"  {player.name}: RAISE {actual_bet} 🔥 (팟: {self.pot})")
        if player.is_all_in:
            print(f"    ⚠️  {player.name} 올인!")

    elif action == Action.ALL_IN:
        all_in_amount = player.chips
        actual_bet = player.bet(all_in_amount)
        self.pot += actual_bet
        if player.current_bet > self.current_bet:
            self.current_bet = player.current_bet
        print(f"  {player.name}: ALL-IN {actual_bet} 💥 (팟: {self.pot})")

    # 현재 상태 출력
    print(f"    칩: {player.chips} | 현재 베팅: {player.current_bet}")
```

---

## 조기 종료 케이스

### 조기 종료 조건

```python
def check_early_finish(self) -> bool:
    """조기 종료 확인"""
    # 폴드하지 않은 플레이어 수
    active_count = sum(1 for p in self.players if not p.has_folded)

    if active_count == 1:
        # 1명만 남음 → 즉시 승리
        winner = next(p for p in self.players if not p.has_folded)
        print(f"\\n🎉 {winner.name}님이 승리! (다른 플레이어 모두 폴드)")
        self.award_pot_to_winner(winner)
        return True

    return False
```

### 조기 종료 시나리오

#### 시나리오 1: 프리플롭에서 모두 폴드
```
상황:
- 플레이어 A (딜러/SB): FOLD
- 플레이어 B (BB): 자동 승리

결과:
- B가 블라인드 획득 (SB + BB)
- 다음 핸드로 즉시 진행
```

#### 시나리오 2: 플롭에서 1명 제외 모두 폴드
```
상황:
- 플레이어 A: RAISE 20
- 플레이어 B: FOLD
- 플레이어 C: FOLD

결과:
- A가 팟 획득
- 홀 카드 공개 불필요
- TURN, RIVER, SHOWDOWN 생략
```

### 구현 코드

```python
def award_pot_to_winner(self, winner: Player):
    """팟을 승자에게 지급"""
    winner.chips += self.pot
    print(f"💰 {winner.name}님이 {self.pot} 칩 획득")
    print(f"   현재 칩: {winner.chips}")
    self.pot = 0
```

---

## 쇼다운 및 팟 분배

### 쇼다운 시퀀스

```python
def showdown(self):
    """쇼다운 - 최종 승자 결정"""
    print("\\n" + "="*50)
    print("  🃏 SHOWDOWN")
    print("="*50)

    # 1. 남은 플레이어 확인
    remaining_players = [p for p in self.players if not p.has_folded]

    if len(remaining_players) == 1:
        # 조기 종료 (이미 처리됨)
        return

    # 2. 각 플레이어 패 공개
    print("\\n플레이어 패:")
    for player in remaining_players:
        hand_str = ", ".join([str(card) for card in player.hand])
        print(f"  {player.name}: {hand_str}")

    print(f"\\n커뮤니티 카드: {', '.join([str(c) for c in self.community_cards])}")

    # 3. 족보 평가
    hands = []
    for player in remaining_players:
        all_cards = player.hand + self.community_cards
        best_hand = HandEvaluator.evaluate_hand(all_cards)
        hands.append((player, best_hand))
        rank, kickers = best_hand
        print(f"  {player.name}: {rank.korean_name}")

    # 4. 승자 결정
    winners = self.determine_winners(hands)

    # 5. 팟 분배
    self.distribute_pot(winners)

def determine_winners(self, hands: List[Tuple[Player, Tuple]]) -> List[Player]:
    """승자 결정"""
    if not hands:
        return []

    # 최고 핸드 찾기
    best_hand = hands[0][1]
    for _, hand in hands[1:]:
        comparison = HandEvaluator.compare_hands(hand, best_hand)
        if comparison > 0:
            best_hand = hand

    # 최고 핸드와 동일한 플레이어들 (무승부 가능)
    winners = []
    for player, hand in hands:
        if HandEvaluator.compare_hands(hand, best_hand) == 0:
            winners.append(player)

    return winners

def distribute_pot(self, winners: List[Player]):
    """팟 분배"""
    if not winners:
        return

    num_winners = len(winners)
    pot_per_winner = self.pot // num_winners
    remainder = self.pot % num_winners

    print(f"\\n💰 팟 분배:")
    for i, winner in enumerate(winners):
        # 기본 분배액
        award = pot_per_winner

        # 나머지 칩은 딜러에 가까운 순서로 분배
        if i < remainder:
            award += 1

        winner.chips += award
        print(f"  🏆 {winner.name}: {award} 칩 획득 (총 {winner.chips} 칩)")

    self.pot = 0
```

### 사이드 팟 처리 (고급)

```python
def create_side_pots(self) -> List[Dict]:
    """사이드 팟 생성"""
    # 올인한 플레이어들의 베팅액 수집
    bets = []
    for player in self.players:
        if not player.has_folded:
            total_bet = player.total_bet_this_hand  # 누적 베팅액
            bets.append((player, total_bet))

    # 베팅액 오름차순 정렬
    bets.sort(key=lambda x: x[1])

    # 사이드 팟 계산
    pots = []
    previous_level = 0

    for i, (player, bet_amount) in enumerate(bets):
        # 이 레벨에 참여할 수 있는 플레이어
        eligible_players = bets[i:]
        num_eligible = len(eligible_players)

        # 팟 금액
        pot_size = (bet_amount - previous_level) * num_eligible

        if pot_size > 0:
            pots.append({
                'amount': pot_size,
                'players': [p for p, _ in eligible_players]
            })

        previous_level = bet_amount

    return pots
```

---

## 게임 종료 조건

### 종료 확인

```python
def is_game_over(self) -> bool:
    """게임 종료 확인"""
    # 칩이 있는 플레이어가 1명 이하
    active_players = [p for p in self.players if p.chips > 0]
    return len(active_players) <= 1

def end_game(self):
    """게임 종료 처리"""
    print("\\n" + "="*50)
    print("  🏁 게임 종료")
    print("="*50)

    # 최종 순위
    ranked = sorted(self.players, key=lambda p: p.chips, reverse=True)

    print("\\n최종 순위:")
    for i, player in enumerate(ranked, 1):
        print(f"  {i}위: {player.name} - {player.chips} 칩")

    # 통계 출력 (옵션)
    self.print_statistics()
```

---

## 구현 체크리스트

### 핵심 기능
- [ ] `new_hand()` - 핸드 시작 로직
- [ ] `move_dealer_button()` - 딜러 버튼 이동
- [ ] `post_blinds()` - 블라인드 베팅
- [ ] `run_betting_round()` - 베팅 라운드 실행
- [ ] `check_early_finish()` - 조기 종료 확인
- [ ] `showdown()` - 쇼다운 처리
- [ ] `distribute_pot()` - 팟 분배

### 헬퍼 함수
- [ ] `get_sb_position()` - SB 위치 계산
- [ ] `get_bb_position()` - BB 위치 계산
- [ ] `get_player_action()` - 플레이어 액션 입력
- [ ] `process_action()` - 액션 처리
- [ ] `is_betting_round_complete()` - 베팅 라운드 종료 확인

### 테스트 케이스
- [ ] 정상 핸드 진행 (PREFLOP → SHOWDOWN)
- [ ] 조기 종료 (프리플롭 폴드)
- [ ] 조기 종료 (플롭/턴/리버 폴드)
- [ ] 올인 상황
- [ ] 사이드 팟 생성
- [ ] 무승부 (Split Pot)

---

## 참고 자료

### 관련 문서
- `docs/게임규칙.md` - 게임 규칙 상세
- `docs/상태다이어그램.md` - FSM 설계

### 관련 파일
- `src/core/game.py` - 게임 로직 구현
- `src/core/player.py` - 플레이어 액션
- `src/algorithms/hand_evaluator.py` - 족보 평가

---

**문서 버전**: 1.0
**최종 수정**: 2025-10-01
