<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Texas Hold'em</title>
    <style>
        body { 
            /* 카드 심볼(♠♥♦♣)이 깨지지 않도록 이모지/심볼 지원 폰트 우선순위 적용 */
            font-family: 'Segoe UI', 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', sans-serif; 
            background-color: #1a1a1a; color: white; margin: 0; overflow: hidden; user-select: none;
        }

        /* --- 로비 --- */
        #lobby-screen { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100;
        }

        .lobby-btn-group { display: flex; gap: 30px; }
        .start-btn { 
            padding: 20px 50px; font-size: 24px; font-weight: bold;
            color: #fff; border-radius: 60px; cursor: pointer;
            box-shadow: 0 10px 20px rgba(0,0,0,0.4); transition: transform 0.2s;
            width: 280px; text-align: center; border: 4px solid #fff;
        }
        .start-btn:hover { transform: scale(1.05); }
        .btn-online { background: linear-gradient(to bottom, #f1c40f, #e67e22); border-color: #d35400; }
        .btn-ai { background: linear-gradient(to bottom, #9b59b6, #8e44ad); border-color: #6c3483; }

        /* --- 게임 테이블 --- */
        #game-screen { display: none; width: 100%; height: 100vh; position: relative; background-color: #2c3e50; }
        
        .poker-table {
            width: 80%; height: 60%; background-color: #35654d; border: 20px solid #5d4037; border-radius: 250px;
            position: absolute; top: 55%; left: 50%; transform: translate(-50%, -50%);
            display: flex; flex-direction: column; justify-content: space-between; align-items: center; padding: 40px;
            box-shadow: inset 0 0 150px rgba(0,0,0,0.6), 0 30px 60px rgba(0,0,0,0.5);
            z-index: 1;
        }

        /* --- 상태 표시 --- */
        #turn-indicator {
            position: absolute; top: 15%; left: 50%; transform: translate(-50%, -50%);
            font-size: 24px; font-weight: bold; background: rgba(0,0,0,0.7);
            padding: 12px 40px; border-radius: 30px; color: #bbb; transition: 0.3s;
            z-index: 10; border: 2px solid rgba(255,255,255,0.1);
        }
        #turn-indicator.my-turn { 
            background: #27ae60; color: white; box-shadow: 0 0 20px #2ecc71; border-color: #2ecc71;
            transform: translate(-50%, -50%) scale(1.1);
        }

        #win-rate-display {
            position: absolute; bottom: 25%; left: 50%; transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8); border: 1px solid #00d2ff; color: #00d2ff;
            padding: 5px 20px; border-radius: 15px; font-size: 16px; font-weight: bold;
            display: none; z-index: 5;
        }

        /* --- 카드 영역 --- */
        .opponent-area, .player-area { display: flex; gap: 10px; height: 100px; align-items: center;}
        .community-area { display: flex; gap: 15px; align-items: center; justify-content: center; height: 100px; }

        /* --- 카드 디자인 --- */
        .card {
            width: 65px; height: 100px; background-color: white; border-radius: 6px;
            box-shadow: 2px 2px 8px rgba(0,0,0,0.4); display: flex; flex-direction: column; justify-content: space-between;
            padding: 5px; box-sizing: border-box; font-weight: bold; font-size: 24px; position: relative;
            /* 카드 내부 폰트도 명시적으로 지정하여 아이콘 깨짐 방지 */
            font-family: 'Segoe UI Symbol', 'Apple Color Emoji', sans-serif;
        }
        .card.dealing { animation: deal-anim 0.5s ease-out forwards; }
        @keyframes deal-anim { from { opacity: 0; transform: translateY(-50px); } to { opacity: 1; transform: translateY(0); } }
        
        .suit-S, .suit-C { color: black; }
        .suit-H, .suit-D { color: #e74c3c; }
        .card-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 40px; }
        .card-bottom { transform: rotate(180deg); }

        .card-back {
            background: repeating-linear-gradient(45deg, #c0392b, #c0392b 10px, #e74c3c 10px, #e74c3c 20px);
            border: 2px solid #fff; display: flex; justify-content: center; align-items: center;
        }
        .card-back::after { 
            content: "♠"; color: rgba(255,255,255,0.2); font-size: 40px; 
            font-family: 'Segoe UI Symbol', sans-serif;
        }

        /* --- 컨트롤 패널 --- */
        .control-panel {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.8); padding: 15px 30px; border-radius: 50px;
            display: flex; gap: 15px; transition: 0.3s; z-index: 20;
        }
        .control-panel.disabled { opacity: 0.5; pointer-events: none; filter: grayscale(100%); }
        .control-panel button {
            padding: 12px 25px; font-size: 16px; border: none; border-radius: 25px;
            cursor: pointer; color: white; font-weight: bold;
        }
        .btn-fold { background-color: #7f8c8d; }
        .btn-check { background-color: #3498db; }
        .btn-call { background-color: #2ecc71; }
        .btn-bet { background-color: #e74c3c; }

        /* --- 로그 --- */
        #log-area { 
            position: fixed; top: 20px; right: 20px; width: 300px; height: 400px; 
            overflow-y: auto; padding: 10px; pointer-events: none;
            display: flex; flex-direction: column-reverse; gap: 8px; z-index: 30; 
        }
        .msg-row { display: flex; width: 100%; opacity: 0; animation: fade-in 0.3s forwards; }
        @keyframes fade-in { to { opacity: 1; } }
        .msg-row.mine { justify-content: flex-end; }
        .msg-row.mine .bubble { background-color: #F7E600; color: #3b1e1e; border-radius: 15px 0 15px 15px; }
        .msg-row.opp { justify-content: flex-start; }
        .msg-row.opp .bubble { background-color: #ffffff; color: #000; border-radius: 0 15px 15px 15px; }
        .msg-row.system { justify-content: center; }
        .msg-row.system .bubble { background-color: rgba(0,0,0,0.4); color: #fff; border-radius: 20px; font-size: 12px; padding: 4px 12px; }
        .bubble { max-width: 80%; padding: 8px 12px; font-size: 14px; box-shadow: 1px 1px 3px rgba(0,0,0,0.3); word-break: break-all; }

        #loading-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; display: none; z-index: 50; }

        /* --- 결과 및 재시작 오버레이 --- */
        #result-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: none; z-index: 60;
            flex-direction: column; justify-content: center; align-items: center;
        }
        #result-title { 
            font-size: 60px; font-weight: bold; color: #f1c40f; 
            margin-bottom: 40px; text-shadow: 0 0 20px black; 
        }
        #restart-btn { 
            padding: 20px 60px; font-size: 28px; font-weight: bold; cursor: pointer; 
            background: #e74c3c; color: white; border: none; border-radius: 50px; 
            box-shadow: 0 5px 20px rgba(231, 76, 60, 0.5); transition: transform 0.2s;
        }
        #restart-btn:hover { transform: scale(1.1); background: #c0392b; }
    </style>
</head>
<body>

    <div id="lobby-screen">
        <h1 style="font-size: 60px; margin-bottom: 50px; text-shadow: 2px 2px 5px rgba(0,0,0,0.5);">Texas Hold'em</h1>
        <div class="lobby-btn-group">
            <button class="start-btn btn-online" onclick="startGame('pvp')">ONLINE MATCH</button>
            <button class="start-btn btn-ai" onclick="startGame('ai')">VS AI (SOLO)</button>
        </div>
    </div>

    <div id="game-screen">
        <div id="turn-indicator">대기 중...</div>
        <div id="log-area"></div>

        <div class="poker-table">
            <div class="opponent-area" id="opp-cards"></div>
            
            <div id="loading-overlay">
                <h3 style="background:rgba(0,0,0,0.7); padding: 10px 20px; border-radius: 10px;">Opponent Searching...</h3>
            </div>
            
            <div class="community-area" id="community-cards"></div>
            <div id="win-rate-display">WIN RATE <span id="win-rate-value">--%</span></div>
            <div class="player-area" id="my-cards"></div>
        </div>

        <div class="control-panel disabled" id="controls">
            <button class="btn-fold" onclick="sendAction('FOLD')">FOLD</button>
            <button class="btn-check" onclick="sendAction('CHECK')">CHECK</button>
            <button class="btn-call" onclick="sendAction('CALL')">CALL</button>
            <button class="btn-bet" onclick="actionBet()">BET</button>
        </div>

        <!-- [NEW] 결과 화면 및 재시작 버튼 -->
        <div id="result-overlay">
            <div id="result-title">GAME OVER</div>
            <!-- 이 버튼을 누르면 서버로 'RESTART' 액션을 보냅니다 (PvP, AI 공용) -->
            <button id="restart-btn" onclick="sendAction('RESTART')">NEW GAME</button>
        </div>
    </div>

    <script>
        let ws = null;
        let currentMode = 'ai'; // 'pvp' or 'ai'

        function startGame(mode) {
            currentMode = mode;
            document.getElementById("lobby-screen").style.display = "none";
            document.getElementById("game-screen").style.display = "block";
            
            const loadingOverlay = document.getElementById("loading-overlay");
            let endpoint = "";

            if (mode === 'pvp') {
                loadingOverlay.style.display = "block";
                endpoint = "/ws/holdem"; 
            } else {
                loadingOverlay.style.display = "none"; 
                endpoint = "/ws/ai";     
            }

            ws = new WebSocket("ws://" + location.host + endpoint);
            
            ws.onmessage = function(event) {
                const data = JSON.parse(event.data);
                
                if (data.type === 'game_start') {
                    // 게임 시작/재시작 시 초기화
                    loadingOverlay.style.display = "none";
                    document.getElementById("result-overlay").style.display = "none";
                    document.getElementById("log-area").innerHTML = ""; 
                    log("게임이 시작되었습니다.", "system");
                }
                else if (data.type === 'update_state') {
                    updateBoard(data.my_hand, data.opp_hand, data.community);
                    if (data.win_rate) updateWinRate(data.win_rate);
                }
                else if (data.type === 'turn_change') {
                    setTurn(data.is_my_turn);
                }
                else if (data.type === 'action_log') {
                    let msg = data.message;
                    let type = "system";
                    if (msg.startsWith("나")) { type = "mine"; msg = msg.replace("나:", "").trim(); }
                    else if (msg.startsWith("상대") || msg.startsWith("AI")) { type = "opp"; msg = msg.replace("상대:", "").replace("AI:", "").trim(); }
                    log(msg, type);
                }
                // [NEW] 게임 종료 처리: 결과창 표시
                else if (data.type === 'game_over') {
                    const overlay = document.getElementById("result-overlay");
                    const title = document.getElementById("result-title");
                    
                    if (data.winner === "PLAYER") {
                        title.innerText = "YOU WIN!";
                        title.style.color = "#f1c40f"; 
                    } else if (data.winner === "AI") {
                        // PvP에서는 'AI'라는 메시지가 '상대방'을 의미
                        title.innerText = "YOU LOSE";
                        title.style.color = "#e74c3c"; 
                    } else {
                        title.innerText = "DRAW";
                        title.style.color = "#ecf0f1"; 
                    }
                    
                    setTimeout(() => {
                        overlay.style.display = "flex";
                    }, 1000);
                }
            };
            
            ws.onclose = function() {
                log("서버와의 연결이 끊어졌습니다.", "system");
            };
        }

        // --- UI 함수들 ---
        function sendAction(actionType, amount = null) {
            let payload = { action: actionType };
            if (amount) payload.amount = amount;
            if(ws) ws.send(JSON.stringify(payload));
        }

        function actionBet() {
            const amount = prompt("베팅 금액:", "100");
            if(amount) sendAction("BET", amount);
        }

        function createCardHTML(rank, suit, isBack = false) { 
            if (isBack) return `<div class="card card-back dealing"></div>`;
            // Fallback: 폰트가 깨질 경우를 대비해 suit 문자 그대로 사용 가능
            const symbol = {'S':'♠','H':'♥','D':'♦','C':'♣'}[suit] || suit;
            const color = (suit==='H'||suit==='D') ? 'suit-H' : 'suit-S';
            return `<div class="card ${color} dealing"><div class="card-top">${rank}${symbol}</div><div class="card-center">${symbol}</div><div class="card-bottom">${rank}${symbol}</div></div>`;
        }

        function updateBoard(myHand, oppHand, community) { 
            const myDiv = document.getElementById("my-cards");
            const oppDiv = document.getElementById("opp-cards");
            const commDiv = document.getElementById("community-cards");

            if(myHand) {
                myDiv.innerHTML = "";
                myHand.forEach(c => myDiv.innerHTML += createCardHTML(c.rank, c.suit));
            }
            if(oppHand) {
                oppDiv.innerHTML = "";
                oppHand.forEach(c => {
                    if(c.hidden) oppDiv.innerHTML += createCardHTML(null, null, true);
                    else oppDiv.innerHTML += createCardHTML(c.rank, c.suit);
                });
            }
            commDiv.innerHTML = "";
            community.forEach(c => commDiv.innerHTML += createCardHTML(c.rank, c.suit));
        }

        function updateWinRate(val) {
            document.getElementById("win-rate-display").style.display = "block";
            document.getElementById("win-rate-value").innerText = val + "%";
        }

        function setTurn(isMyTurn) {
            const controls = document.getElementById("controls");
            const indicator = document.getElementById("turn-indicator");
            if(isMyTurn) {
                controls.classList.remove("disabled");
                indicator.classList.add("my-turn");
                indicator.innerText = "MY TURN";
            } else {
                controls.classList.add("disabled");
                indicator.classList.remove("my-turn");
                indicator.innerText = "OPPONENT'S TURN";
            }
        }

        function log(msg, type = "system") {
            const area = document.getElementById("log-area");
            const row = document.createElement("div");
            row.className = `msg-row ${type}`;
            const bubble = document.createElement("div");
            bubble.className = "bubble";
            bubble.innerText = msg;
            row.appendChild(bubble);
            area.prepend(row);
        }
    </script>
</body>
</html>